---
title: "GAGA phylogeny with LGT highlights"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    collapsed: true
    number_sections: true
    df_print: paged
  pdf_document: default
---
<STYLE TYPE="text/css">
<!--
  td{
    font-family: Arial; 
    font-size: 8pt;
    padding:0px;
    cellpadding="0";
    cellspacing="0"
  }
  th {
    font-family: Arial; 
    font-size: 8pt;
    height: 20px;
    font-weight: bold;
    text-align: right;
    background-color: #ccccff;
  }
  table { 
    border-spacing: 0px;
    border-collapse: collapse;
  }
--->
</STYLE>


Load the necessary R libraries
```{r}
#devtools::install_github("GuangchuangYu/ggtree")
library(treeio)
library(ggtree)
library(phytools)
library(viridisLite)
library(ggplot2)
library(googlesheets4)
library(dplyr)
```

Load data from google spreadsheet (Already stored in an R object that you can just load)
```{r}
#id<-"1e7Hj_BQ8rke5XW7j93YL6QVAGbcvsb2yw7oD86WnPJY"
#gsheet<-read_sheet(id,sheet="GlobalOverview",skip = 2,na = c(""," ","NA","#DIV/0!"),col_types = "c",trim_ws=T)
#GlobalOverview<-as.data.frame(gsheet,stringsAsFactors=F)
#save(GlobalOverview,file="../../misc/data/gsheet.GlobalOverview.21-09-22.Robj")
load("/Users/Janina/Documents/MASTER/Masterarbeit/lgt/1_code/r_scripts/gsheet.GlobalOverview.21-09-22.Robj")
```

Create a dataframe where the first row is the GAGA id (e.g. GAGA-0002), which are also used as the tip labels in the phylogeny
```{r}
data2add<-data.frame(GAGA.id = GlobalOverview$`GAGA ID`, GlobalOverview)
```

Create a column with clean species IDs for all species. 

This has to be done, because the database of all the sequenced species is a bit convoluted.
```{r}
data2add$cleanSpeciesID<-dplyr::coalesce(data2add$Species,data2add$Species..from.Assembly.Overview.)
```


Load the tree file of all the GAGA genomes.
```{r}
tree <- read.iqtree("/Users/Janina/Documents/MASTER/Masterarbeit/lgt/1_code/r_scripts/hymenoptera_psc98_partition_b1000_40threads_msubnucl.treefile")
```

Create a very quick and dirty plot of the phylogeny
```{r}
plot(tree@phylo,show.node.label = T,show.tip.label = T,cex=.5)
nodelabels(bg=rgb(0,0,0,0),col="red",frame = "none")
```

check the plot to see where the root should be. Here we root the tree at node 166 that separates the outgroups, the honeybee "Amel" (Apis mellifera) and the parasitoid wasp Nasonia (Nvit), from ants.
```{r}
#tree.rooted<-treeio::root(tree,node=166)
tree.rooted <- tree
tree.rooted.subset<-treeio::drop.tip(tree.rooted,tip=c("NCBI-0018_Amel","NCBI-0019_Nvit"))
```

Plot basic tree
```{r}
tp<-ggtree(tree.rooted.subset,ladderize = T)+geom_rootedge(.01)
```

Add the species identity from `FAS.genes.and.names.tsv`
```{r}
tp$data$label[tp$data$isTip==T]<-gsub("_.*","",tp$data$label[tp$data$isTip==T])

tp2<-tp %<+% data2add
```

Make complex tree
```{r}
tp3<-tp2 + 
  geom_tiplab(aes(label=paste(label,cleanSpeciesID,sep=" ")),size=2,align = T,linesize = .1)+    #add the tip labels
  geom_nodepoint(aes(fill=UFboot),stroke=0.5,pch=21,size=2)+       #add the info about bootstrapping success as points of different colors to the nodes
  scale_fill_viridis_c()+                                          #change the color of the node points to a viridis color scale
  theme(legend.position = c(0.1,.9))+
  coord_cartesian(xlim=c(0,.4))
```

```{r}
tp3 #plot the tree
#ggsave("../../misc/plots/GAGA.phylogeny.pdf",width = 8,height=12) #save the tree in a pdf
```

# read LGT data
```{r}
library(readxl)
```

```{r}
LGTs.raw<-read_excel("/Users/Janina/Documents/MASTER/Masterarbeit/lgt/0_data/GAGA.LGT.162.resulting.good.candidates.xlsx")
```

Clean up the LGT dataframe to remove the database origin (GAGA-0001.euk -> GAGA-0001)
```{r}
LGTs<-LGTs.raw
LGTs$GAGAid<-gsub("\\..*","",LGTs$.id)
```

Create a tally dataframe that counts how many LGT candidates we have per species. 
```{r}
LGT.tally<-as.data.frame(table(select(LGTs,GAGAid)))
colnames(LGT.tally)<-c("GAGAid","LGT.count")
```

Add the LGT.tally dataframe to the phylogeny object as additional data.
```{r}
tp4<-tp3 %<+% LGT.tally
# see tp4$data$LGT.count
```

Plot the phylogeny and add red dot to the tip, where the size of the red dot represents the number of identified LGTs
```{r}
tp5<-tp4+geom_tippoint(aes(size=LGT.count),col="red",alpha=.5)
tp5
ggsave("../../misc/plots/GAGA.phylogeny.LGTs.pdf",width = 8,height=12) #save the tree in a pdf
```


```{r}
LGT.Wolbachia.tally<-subset(LGTs,suggested_prokaryote_origin=="Wolbachia") %>% group_by(GAGAid) %>% tally()
colnames(LGT.Wolbachia.tally)<-c("GAGAid","LGT.Wolbachia.count")

tp6<-tp5 %<+% LGT.Wolbachia.tally
```


