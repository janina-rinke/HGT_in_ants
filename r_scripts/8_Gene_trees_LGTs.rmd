---
title: "Phylogeny creator"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    collapsed: true
    number_sections: true
    df_print: paged
  pdf_document: default
---
<STYLE TYPE="text/css">
<!--
  td{
    font-family: Arial;
    font-size: 8pt;
    padding:0px;
    cellpadding="0";
    cellspacing="0"
  }
  th {
    font-family: Arial;
    font-size: 8pt;
    height: 20px;
    font-weight: bold;
    text-align: right;
    background-color: #ccccff;
  }
  table {
    border-spacing: 0px;
    border-collapse: collapse;
  }
--->
</STYLE>


This script serves to create gene trees for all single LGTs. 

Load the necessary R libraries
```{r}
# to install treeio
#if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("treeio")
library(treeio)
#BiocManager::install("ggtree")
library(ggtree)
library(phytools)
library(viridisLite)
library(ggplot2)
library(UniprotR) #install.packages("UniprotR, type="binary")
```

Load tree file and other files containing information about LGT or other
```{r}
tree <- read.tree("/Users/Janina/Documents/MASTER/Masterarbeit/lgt/0_data/trees/CFA_synthases.aln.treefile")
```

Plot a simple Tree without any details, yet
```{r}
tp<-ggtree(tree, ladderize = TRUE) # plot tree (branch.length ="none")
tp
```

Create more detailed trees

Create an `all_info` data.frame holding some data you want to plot onto the phylogeny. Here, we are going to retrieve information from Uniprot using the R package `UniprotR`.

```{r}
all_info<-data.frame(id=tp$data$label[tp$data$isTip==T],length=as.numeric(gsub(".*_","",tp$data$label[tp$data$isTip==T])))

## so we don't try to retrieve UniPROT data for the LGT, we mark it first.
#mark the LGT in a new column "type"
all_info$type<-"blasthit"
# set the species for the LGT to "LGT"
#all_info$type[grep("MGA_.+_LOCUS",all_info$id)]<-"LGT"
all_info$type[grep("LGT",all_info$id)]<-"LGT"


## Access Uniprot!
# You can add any other info to this table and then later add it to the phylogeny
# Now, we query Uniprot to retrieve info about our hits
library(UniprotR)

#extract the representativeIDs from the blast hit names
all_info$representativeIDs<-gsub(".*RepID_(.*?)_.*","\\1",all_info$id)

# query unirprot with the representative IDs.
df.representativeIDs<-GetNamesTaxa(all_info$representativeIDs[all_info$type!="LGT"])
all_info<-merge(all_info,df.representativeIDs,by.x="representativeIDs",by.y="row.names",all.x=T)

```


```{r}
# add info data to tree. Here, it is important that the first column of all_info matches the tip labels of the phylogeny
all_info_sorted<-all_info[,c(2,1,3:ncol(all_info))]
tp2 <- tp %<+% all_info_sorted
#tp2

# also set Protein.names for the LGT (so far not defined)
tp2$data$Protein.names[tp2$data$type=="LGT" & !is.na(tp2$data$type)]<-"LGT"
# plot tree with more details
tp3 <-tp2 +
  geom_tiplab(aes(label=Protein.names,color=type), align=T,offset =.2,size=3)  + # add a label to the tip and set the color depending on whether or not the label contains the term MGA
  theme(legend.position="bottom")+
  geom_tippoint(aes(size=length,fill=Organism),pch=21)+ # add a point to the end of the branches. The point is relative to the length of the protein, and the color relates to the species
  xlim(0,5)+
  theme(legend.position = "right",legend.spacing = unit(0.05, 'cm'),legend.key.size = unit(.1, "cm"))+ # adjust the legend so its not that large
  guides(colour="none")+
  scale_color_manual(values=c("black","steelblue")) # change the color of the tip label levels

tp3

```
